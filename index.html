<!DOCTYPE html>

<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Evo-Labor</title>
<script src=""></script>
<style>
body { margin: 0; padding: 0; overflow: hidden; background: #0a0f19; touch-action: none; font-family: sans-serif; }
canvas { display: block; }
</style>
</head>
<body>
<script>
let creatures = [];
const genNames = ["OBERARM", "UNTERARM", "BEIN OBEN", "BEIN UNTEN", "SCHULTER", "HÃœFTE", "ELLBOGEN", "KNIE", "KOPF"];
let displayGenes = [], targetGenes = [], generation = 1;
let initialGenes = [2, 1.5, 2.5, 2, 0.4, 0.4, 0.6, 0.3, 0.8];
let lastMutation = "START";
let selectionCount = new Array(9).fill(0);

function setup() {
createCanvas(windowWidth, windowHeight);
displayGenes = [...initialGenes];
targetGenes = [...initialGenes];
generateMutants(new DNA(initialGenes));
}

function windowResized() { resizeCanvas(windowWidth, windowHeight); }

function draw() {
background(10, 15, 25);
for (let i = 0; i < displayGenes.length; i++) {
displayGenes[i] = lerp(displayGenes[i], targetGenes[i], 0.03);
}
let pHA = height * 0.35;
noStroke(); fill(20, 25, 40);
rect(10, 10, width - 20, pHA - 20, 20);
drawStickman(width/2, pHA/2 + 15, displayGenes, 1.4, color(0, 255, 200), -1);

let dbY = pHA;
let dbH = height * 0.15;
fill(15, 20, 30); rect(10, dbY, width - 20, dbH - 10, 15);
fill(0, 255, 200); textAlign(LEFT); textSize(14);
text("GEN: " + generation, 25, dbY + 25);

let dist = 0;
for(let i=0; i<9; i++) dist += abs(targetGenes[i] - initialGenes[i]);
fill(255, 120); textSize(11);
text("ABWEICHUNG: " + dist.toFixed(2), 25, dbY + 45);
text("LETZTE WAHL: " + lastMutation, 25, dbY + 65);

textAlign(RIGHT); fill(255, 60); text("FOKUS:", width - 25, dbY + 25);
let maxVal = max(selectionCount);
for(let i=0; i<9; i++) {
let barW = map(selectionCount[i], 0, maxVal || 1, 0, 60);
fill(255, 15); rect(width - 85, dbY + 35 + (i * 5), 60, 3);
fill(255, 200, 0, 150); rect(width - 85, dbY + 35 + (i * 5), barW, 3);
}

let gridY = dbY + dbH;
let childW = (width - 30) / 2;
let childH = (height - gridY - 20) / 4;
for (let i = 0; i < 8; i++) {
let col = i % 2; let row = floor(i / 2);
let x = 15 + col * childW + childW/2;
let y = gridY + row * childH + childH/2;
let kX = 15 + col * childW + 4;
let kY = gridY + row * childH + 4;
fill(255, 4); noStroke();
rect(kX, kY, childW - 8, childH - 8, 12);
creatures[i].show(x, y, 0.5);
textAlign(LEFT); textSize(9); fill(255, 200, 0, 180);
text(genNames[creatures[i].mutatedGene], kX + 8, kY + 15);
}
}

function touchStarted() {
let pHA = height * 0.35; let dbH = height * 0.15;
let gridY = pHA + dbH;
if (mouseY < gridY) return false;
let childW = (width - 30) / 2;
let childH = (height - gridY - 20) / 4;
let col = floor((mouseX - 15) / childW);
let row = floor((mouseY - gridY) / childH);
let index = col + row * 2;
if (index >= 0 && index < 8) {
let selected = creatures[index];
lastMutation = genNames[selected.mutatedGene];
selectionCount[selected.mutatedGene]++;
targetGenes = [...selected.dna.genes];
generation++;
generateMutants(selected.dna);
}
return false;
}

function mousePressed() { if (mouseX > 0 && mouseY > 0) touchStarted(); }

function generateMutants(parentDNA) {
creatures = [];
for (let i = 0; i < 8; i++) {
let newDNA = new DNA(parentDNA.genes);
let mutIdx = floor(random(9));
newDNA.genes[mutIdx] += random([-1, 1]) * 0.55;
newDNA.genes[mutIdx] = constrain(newDNA.genes[mutIdx], 0.2, 5);
creatures.push(new Strichmensch(newDNA, mutIdx));
}
}

class DNA { constructor(genes) { this.genes = [...genes]; } }
class Strichmensch {
constructor(dna, mIdx) { this.dna = dna; this.mutatedGene = mIdx; }
show(x, y, s) { drawStickman(x, y, this.dna.genes, s, color(200, 200, 220, 100), this.mutatedGene); }
}

function drawStickman(x, y, genes, s, baseCol, mIdx) {
push(); translate(x, y); scale(s);
let highCol = color(255, 180, 0);
strokeWeight(4); stroke(baseCol); line(0, 0, 0, 30);
let hSize = 10 + genes[8] * 10;
stroke(mIdx === 8 ? highCol : baseCol);
if(mIdx === 8) strokeWeight(8);
noFill(); ellipse(0, -10 - hSize/2, hSize, hSize);
for(let side of [-1, 1]) {
drawLimb(0, 5, genes[0]*12, genes[1]*12, genes[4]*side, genes[6]*side, side, baseCol, highCol, mIdx, [0, 1, 4, 6]);
drawLimb(0, 30, genes[2]*12, genes[3]*12, genes[5]*side, genes[7]*side, side, baseCol, highCol, mIdx, [2, 3, 5, 7]);
}
pop();
}

function drawLimb(sx, sy, ul, ll, ua, la, side, c, hc, mIdx, gIds) {
let isMut = gIds.includes(mIdx); stroke(isMut ? hc : c);
strokeWeight(isMut ? 8 : 4);
let ux = sx + sin(ua) * ul; let uy = sy + cos(ua) * ul;
line(sx, sy, ux, uy); line(ux, uy, ux + sin(ua + la) * ll, uy + cos(ua + la) * ll);
}
</script>

</body>
</html>
