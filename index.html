<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Evo-Labor</title>
<style>
body{
  margin:0;
  overflow:hidden;
  background:#0a0f19;
  font-family:sans-serif;
  color:white;
}
canvas{ display:block; }
</style>
</head>
<body>
<canvas id="canvas"></canvas>

<script>

// ================= GENE DEFINITIONS =================

const GENE_NAMES = [
  "Oberarm",
  "Unterarm",
  "Oberschenkel",
  "Unterschenkel",
  "Schulterwinkel",
  "Hüftwinkel",
  "Ellbogenwinkel",
  "Kniewinkel",
  "Kopfgröße"
];

// ================= UTILS =================

const U = {
  clamp:(v,min,max)=>Math.max(min,Math.min(max,v)),
  randInt:(max)=>Math.floor(Math.random()*max),
  choice:(a)=>a[Math.floor(Math.random()*a.length)]
};

// ================= DNA =================

class DNA{
  constructor(genes){
    this.genes=[...genes];
    this.lastMutation=null;
  }

  clone(){
    const d=new DNA(this.genes);
    d.lastMutation=this.lastMutation;
    return d;
  }

  mutate(){
    const idx=U.randInt(this.genes.length);
    this.genes[idx]+=U.choice([-1,1])*0.55;
    this.genes[idx]=U.clamp(this.genes[idx],0.2,5);
    this.lastMutation=idx;
  }
}

// ================= CREATURE =================

class Creature{
  constructor(dna){
    this.dna=dna;
  }

  draw(ctx,x,y,scale,isParent=false){
    const g=this.dna.genes;
    const mut=this.dna.lastMutation;

    ctx.save();
    ctx.translate(x,y);
    ctx.scale(scale,scale);

    const base=isParent
      ? "rgba(0,255,200,0.9)"
      : "rgba(200,200,220,0.8)";

    const highlight="rgba(255,180,0,1)";

    const strokePart=(geneIndex)=>{
      if(mut===geneIndex && !isParent){
        ctx.strokeStyle=highlight;
        ctx.lineWidth=6;
      }else{
        ctx.strokeStyle=base;
        ctx.lineWidth=3;
      }
    };

    // torso
    ctx.strokeStyle=base;
    ctx.lineWidth=3;
    ctx.beginPath();
    ctx.moveTo(0,0);
    ctx.lineTo(0,30);
    ctx.stroke();

    // head
    let head=10+g[8]*10;
    strokePart(8);
    ctx.beginPath();
    ctx.arc(0,-10-head/2,head/2,0,Math.PI*2);
    ctx.stroke();

    const limb=(sx,sy,ul,ll,ua,la,ids)=>{
      const ux=sx+Math.sin(ua)*ul;
      const uy=sy+Math.cos(ua)*ul;

      strokePart(ids[0]);
      ctx.beginPath();
      ctx.moveTo(sx,sy);
      ctx.lineTo(ux,uy);
      ctx.stroke();

      strokePart(ids[1]);
      ctx.beginPath();
      ctx.moveTo(ux,uy);
      ctx.lineTo(
        ux+Math.sin(ua+la)*ll,
        uy+Math.cos(ua+la)*ll
      );
      ctx.stroke();
    };

    for(let s of [-1,1]){
      limb(0,5,g[0]*12,g[1]*12,g[4]*s,g[6]*s,[0,1]);
      limb(0,30,g[2]*12,g[3]*12,g[5]*s,g[7]*s,[2,3]);
    }

    ctx.restore();
  }
}

// ================= APP =================

class App{
  constructor(){
    this.canvas=document.getElementById("canvas");
    this.ctx=this.canvas.getContext("2d");
    this.resize();
    window.addEventListener("resize",()=>this.resize());

    this.generation=1;
    this.parentDNA=new DNA([2,1.5,2.5,2,0.4,0.4,0.6,0.3,0.8]);
    this.children=[];
    this.generateChildren();

    window.addEventListener("click",(e)=>this.handleClick(e));
    this.loop();
  }

  resize(){
    this.canvas.width=window.innerWidth;
    this.canvas.height=window.innerHeight;
  }

  generateChildren(){
    this.children=[];
    for(let i=0;i<8;i++){
      const dna=this.parentDNA.clone();
      dna.mutate();
      this.children.push(new Creature(dna));
    }
  }

  handleClick(e){
    const w=this.canvas.width;
    const h=this.canvas.height;

    const gridTop=h*0.48;
    const cellW=w/4;
    const cellH=(h-gridTop)/2;

    const col=Math.floor(e.clientX/cellW);
    const row=Math.floor((e.clientY-gridTop)/cellH);
    const index=row*4+col;

    if(row>=0 && row<2 && col>=0 && col<4){
      if(this.children[index]){
        this.parentDNA=this.children[index].dna.clone();
        this.generation++;
        this.generateChildren();
      }
    }
  }

  drawUI(){
    const ctx=this.ctx;

    ctx.fillStyle="rgba(255,255,255,0.8)";
    ctx.font="16px sans-serif";
    ctx.textAlign="left";
    ctx.fillText("Generation: "+this.generation,20,30);
  }

  loop(){
    const ctx=this.ctx;
    const w=this.canvas.width;
    const h=this.canvas.height;

    ctx.fillStyle="#0a0f19";
    ctx.fillRect(0,0,w,h);

    // Parent
    new Creature(this.parentDNA)
      .draw(ctx,w/2,h*0.25,2,true);

    // Children
    const gridTop=h*0.48;
    const cellW=w/4;
    const cellH=(h-gridTop)/2;

    for(let i=0;i<8;i++){
      const col=i%4;
      const row=Math.floor(i/4);
      const x=col*cellW+cellW/2;
      const y=gridTop+row*cellH+cellH*0.4;

      this.children[i].draw(ctx,x,y,0.8,false);

      const mut=this.children[i].dna.lastMutation;

      // Klar unterhalb der Figur
      ctx.fillStyle="rgba(255,180,0,1)";
      ctx.font="14px sans-serif";
      ctx.textAlign="center";
      ctx.fillText(
        "Mutation: " + GENE_NAMES[mut],
        x,
        gridTop + row*cellH + cellH - 20
      );
    }

    this.drawUI();
    requestAnimationFrame(()=>this.loop());
  }
}

new App();

</script>
</body>
</html>
